<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… ØªÙ‚Ø§Ø±ÙŠØ± ECG Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Cairo', sans-serif; padding: 20px; background: #f0f4f8; color: #333; }
        .container { max-width: 1350px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { display: flex; gap: 15px; margin-bottom: 30px; background: #fff; padding: 20px; border: 1px solid #d1d9e6; border-radius: 12px; align-items: center; }
        input[type="file"], input[type="text"] { flex: 1; padding: 12px; border: 2px solid #cbd5e0; border-radius: 8px; font-family: 'Cairo'; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #1a73e8; }
        
        button { padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-search { background: #1a73e8; color: white; }
        .btn-pdf { background: #d93025; color: white; display: none; }
        button:hover { transform: translateY(-2px); opacity: 0.9; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
        #pdf-area { padding: 10px; background: white; }
        .dynamic-header { 
            text-align: center; 
            font-size: 24px; 
            font-weight: bold; 
            margin-bottom: 25px; 
            color: #004085;
            padding: 15px;
            border: 3px double #004085;
            text-transform: uppercase;
            background: #f8f9fa;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: auto; }
        th { 
            background-color: #004085; 
            color: #ffffff; 
            padding: 12px 8px;
            border: 1px solid #000;
            font-size: 14px;
            white-space: nowrap;
        }
        td { border: 1px solid #000; padding: 10px 5px; text-align: center; font-size: 13px; color: #000; }
        tr:nth-child(even) { background-color: #f2f5f8; }
        
        .zero-val { font-weight: bold; color: #e67e22; background: #fff3e0; padding: 2px 5px; border-radius: 4px; }
        #status { text-align: center; margin: 15px; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#1a73e8; margin-top:0;">Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆØ­Ø¯ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
    
    <div class="controls">
        <input type="file" id="fileInput" multiple accept=".xlsx, .xls">
        <input type="text" id="filterInput" placeholder="Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¨Ø­Ø« (Ù…Ø«Ù„Ø§Ù‹: 0 Ø£Ùˆ OPEN)...">
        <button class="btn-search" onclick="processFiles()">ğŸ” ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button id="pdfBtn" class="btn-pdf" onclick="generatePDF()">ğŸ“„ Ø­ÙØ¸ PDF Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©</button>
    </div>
    
    <div id="status"></div>

    <div id="pdf-area">
        <div id="reportTitle" class="dynamic-header" style="display:none;"></div>
        
        <table id="resultTable" style="display:none;">
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                    <th>REV</th>
                    <th>CL</th>
                    <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯</th>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ù…Ù‡Ù†Ø¯Ø³ ECG</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠÙƒÙˆÙ† DD-MM-YYYY
    function formatDate(d) {
        if (d === 0 || d === "0") return "0";
        if (!d || d === "") return "-";
        
        let date;
        if (typeof d === 'number' && d > 30000) {
            date = new Date((d - 25569) * 86400 * 1000);
        } else {
            date = new Date(d);
        }

        if (isNaN(date.getTime())) return d;

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }

    async function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const filterInput = document.getElementById('filterInput').value.trim();
        const tableBody = document.getElementById('tableBody');
        const status = document.getElementById('status');
        const reportTitle = document.getElementById('reportTitle');
        
        if (!fileInput.files.length || filterInput === "") {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¨Ø­Ø«");
            return;
        }

        status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø´ÙŠØªØ§Øª... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
        tableBody.innerHTML = "";
        let count = 0;
        let firstOrderNumber = ""; 

        for (let file of fileInput.files) {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { cellDates: true });
            
            wb.SheetNames.forEach(name => {
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { defval: "" });
                rows.forEach(row => {
                    // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ÙƒÙˆØ¯ (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù)
                    if (String(row["Ø§Ù„ÙƒÙˆØ¯"]).trim().toUpperCase() === filterInput.toUpperCase()) {
                        count++;
                        
                        // Ø§Ù„ØªÙ‚Ø§Ø· Ø£ÙˆÙ„ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                        if (!firstOrderNumber && row["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]) {
                            firstOrderNumber = String(row["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]);
                        }

                        let tr = document.createElement('tr');
                        const columns = ["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨", "REV", "CL", "Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯", "Ø§Ù„ÙƒÙˆØ¯", "Ù…Ù‡Ù†Ø¯Ø³ ECG"];

                        columns.forEach(col => {
                            let td = document.createElement('td');
                            let val = row[col];

                            if (val === 0 || val === "0") {
                                td.innerHTML = `<span class="zero-val">0</span>`;
                            } else if (col.includes("ØªØ§Ø±ÙŠØ®")) {
                                td.innerText = formatDate(val);
                            } else {
                                td.innerText = val || "-";
                            }
                            tr.appendChild(td);
                        });
                        tableBody.appendChild(tr);
                    }
                });
            });
        }

        if (count > 0) {
            // ØªØ­Ù„ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØ§Ù„Ù†ÙˆØ¹
            // Ø§Ù„Ù…Ø«Ø§Ù„: EGC-ECG-DWG-ARCH-0024 -> Ø§Ù„Ø´Ø±ÙƒØ© EGC (1) ÙˆØ§Ù„Ù†ÙˆØ¹ DWG (3)
            let company = "EGC"; 
            let docType = "MAT";
            
            if (firstOrderNumber.includes("-")) {
                let parts = firstOrderNumber.split("-");
                if (parts[0]) company = parts[0]; 
                if (parts[2]) docType = parts[2]; 
            }

            const today = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
            reportTitle.innerText = `${company}-${docType}-${filterInput.toUpperCase()} ${today}`;
            
            reportTitle.style.display = "block";
            document.getElementById('resultTable').style.display = "table";
            document.getElementById('pdfBtn').style.display = "flex";
            status.innerHTML = `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ <span style="color:#1a73e8">${count}</span> Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.`;
        } else {
            status.innerHTML = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯.";
            reportTitle.style.display = "none";
            document.getElementById('resultTable').style.display = "none";
            document.getElementById('pdfBtn').style.display = "none";
        }
    }

    function generatePDF() {
        const element = document.getElementById('pdf-area');
        const filterVal = document.getElementById('filterInput').value;
        const opt = {
            margin:       [10, 5, 10, 5],
            filename:     `Report_${filterVal}_${new Date().getTime()}.pdf`,
            image:        { type: 'jpeg', quality: 1 },
            html2canvas:  { 
                scale: 3, 
                useCORS: true, 
                letterRendering: true,
                dpi: 300
            },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };
        
        status.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ù…Ù„Ù PDF Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©...";
        html2pdf().set(opt).from(element).save().then(() => {
            status.innerHTML = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.";
        });
    }
</script>

</body>
</html>
