<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ECG System - Legacy Support</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 10px; background: #f0f4f8; }
        .container { width: 100%; margin: auto; background: white; padding: 10px; border-radius: 8px; }
        .no-print { background: #eee; padding: 15px; border: 1px solid #ccc; margin-bottom: 10px; }
        
        /* تصغير الأحجام قليلاً لتناسب شاشة التاب p5100 */
        input, button { padding: 10px; font-size: 16px; margin: 5px; }
        input[type="file"] { width: 90%; }
        #filterInput { width: 150px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; }
        th { background-color: #004085; color: white; padding: 8px; border: 1px solid #000; }
        td { border: 1px solid #000; padding: 5px; text-align: center; word-wrap: break-word; }
        
        /* منع كسر السطر في الأعمدة الثلاثة */
        .no-wrap { white-space: nowrap !important; font-size: 10px; }

        @media print {
            .no-print { display: none !important; }
            @page { size: A4 landscape; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h3>ECG Reports (Tab P5100 Version)</h3>
        <input type="file" id="fileInput" multiple>
        <br>
        <input type="text" id="filterInput" placeholder="Insert Code">
        <button onclick="processFiles()">View Report</button>
        <button id="printBtn" style="display:none;" onclick="window.print()">Print</button>
    </div>
    <div id="report-container"></div>
</div>

<script>
    // تعديل دالة التاريخ لتكون أبسط للمتصفحات القديمة
    function formatDate(d) {
        if (!d || d === 0 || d === "0") return "-";
        try {
            var date = (typeof d === 'number') ? new Date((d - 25569) * 86400 * 1000) : new Date(d);
            var day = date.getDate() < 10 ? '0' + date.getDate() : date.getDate();
            var month = (date.getMonth() + 1) < 10 ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1);
            return day + '-' + month + '-' + date.getFullYear();
        } catch(e) { return d; }
    }

    function processFiles() {
        var fileInput = document.getElementById('fileInput');
        var filterInput = document.getElementById('filterInput').value.toUpperCase();
        var reportContainer = document.getElementById('report-container');
        
        if (!fileInput.files.length || !filterInput) {
            alert("Please select files and enter code");
            return;
        }

        reportContainer.innerHTML = "Loading...";
        var groupedData = {};

        // استخدام FileReader التقليدي المتوافق مع الأجهزة القديمة
        var files = fileInput.files;
        var filesProcessed = 0;

        for (var i = 0; i < files.length; i++) {
            (function(file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array', cellDates: true});
                    
                    workbook.SheetNames.forEach(function(sheetName) {
                        var json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        json.forEach(function(row) {
                            if (String(row["الكود"] || "").toUpperCase().trim() === filterInput) {
                                var order = String(row["رقم الطلب"] || "");
                                var type = order.split("-")[2] || "OTHERS";
                                if (!groupedData[type]) groupedData[type] = [];
                                groupedData[type].push(row);
                            }
                        });
                    });

                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        renderReport(groupedData, filterInput);
                    }
                };
                reader.readAsArrayBuffer(file);
            })(files[i]);
        }
    }

    function renderReport(data, filter) {
        var container = document.getElementById('report-container');
        container.innerHTML = "";
        var keys = [];
        for (var k in data) keys.push(k);
        
        if (keys.length === 0) {
            container.innerHTML = "No Results Found";
            return;
        }

        keys.forEach(function(key) {
            var html = '<div style="page-break-after:always;">';
            html += '<h2 style="text-align:center;">' + key + ' - ' + filter + '</h2>';
            html += '<table><thead><tr>';
            html += '<th>Order No</th><th>REV</th><th>CL</th><th>Subject</th><th>Rec. Date</th><th>Reply Date</th><th>Code</th><th>Eng</th>';
            html += '</tr></thead><tbody>';
            
            data[key].forEach(function(row) {
                html += '<tr>';
                html += '<td class="no-wrap">' + (row["رقم الطلب"] || "") + '</td>';
                html += '<td>' + (row["REV"] || "0") + '</td>';
                html += '<td>' + (row["CL"] || "-") + '</td>';
                html += '<td style="text-align:right">' + (row["الموضوع"] || "") + '</td>';
                html += '<td class="no-wrap">' + formatDate(row["تاريخ الاستلام"]) + '</td>';
                html += '<td class="no-wrap">' + formatDate(row["تاريخ الرد"]) + '</td>';
                html += '<td>' + (row["الكود"] || "") + '</td>';
                html += '<td>' + (row["مهندس ECG"] || "-") + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML += html;
        });
        document.getElementById('printBtn').style.display = "inline";
    }
</script>

</body>
</html>
