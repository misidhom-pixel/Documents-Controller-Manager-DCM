<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ECG Report System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Cairo', sans-serif; padding: 20px; background: #f0f4f8; margin: 0; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 12px; }
        .no-print { background: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd; }
        button { padding: 12px 25px; background: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; }
        
        /* تنسيق التقرير */
        .page-wrapper { width: 100%; background: white; page-break-after: always; } /* فصل الصفحة بعد كل جدول */
        .dynamic-header { 
            text-align: center; font-size: 22px; font-weight: bold; 
            margin-bottom: 15px; padding: 10px; border: 2px solid #004085; 
            color: #004085; background: #f9f9f9; 
        }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 30px; }
        th { background-color: #004085 !important; color: white !important; padding: 10px; border: 1px solid #000; font-size: 13px; }
        td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 11px; word-wrap: break-word; }
        .zero-val { font-weight: bold; color: #d35400; }

        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            .no-print { display: none !important; }
            .page-wrapper { page-break-after: always; }
            th { -webkit-print-color-adjust: exact; background-color: #004085 !important; color: white !important; }
        }

        /* أحجام الأعمدة */
        th:nth-child(1) { width: 18%; } th:nth-child(2) { width: 5%; }
        th:nth-child(3) { width: 5%; } th:nth-child(4) { width: 32%; }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h2>ECG Report System<h2>
        <input type="file" id="fileInput" multiple accept=".xlsx, .xls">
        <input type="text" id="filterInput" placeholder="Code">
        <button onclick="processFiles()">View</button>
        <button id="printBtn" style="background:#28a745; display:none;" onclick="window.print()">Print</button>
    </div>

    <div id="report-container"></div>
</div>

<script>
    function formatDate(d) {
        if (d === 0 || d === "0") return "0";
        if (!d) return "-";
        let date = (typeof d === 'number' && d > 30000) ? new Date((d - 25569) * 86400 * 1000) : new Date(d);
        return isNaN(date.getTime()) ? d : `${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`;
    }

    async function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const filterInput = document.getElementById('filterInput').value.trim().toUpperCase();
        const reportContainer = document.getElementById('report-container');
        
        if (!fileInput.files.length || filterInput === "") return alert("Insert Data");
        reportContainer.innerHTML = "";
        
        let groupedData = {}; // تجميع البيانات حسب النوع

        for (let file of fileInput.files) {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { cellDates: true });
            
            wb.SheetNames.forEach(name => {
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { defval: "" });
                rows.forEach(row => {
                    if (String(row["الكود"]).trim().toUpperCase() === filterInput) {
                        let orderNum = String(row["رقم الطلب"] || "");
                        let parts = orderNum.split("-");
                        let company = parts[0] || "EGC";
                        let docType = parts[2] || "OTHERS"; // استخراج النوع (DOC أو DWG)
                        
                        let groupKey = `${company}-${docType}`;
                        if (!groupedData[groupKey]) groupedData[groupKey] = [];
                        groupedData[groupKey].push(row);
                    }
                });
            });
        }

        const keys = Object.keys(groupedData);
        if (keys.length > 0) {
            keys.forEach(groupKey => {
                const today = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
                let html = `
                    <div class="page-wrapper">
                        <div class="dynamic-header">${groupKey}-${filterInput} ${today}</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>رقم الطلب</th><th>REV</th><th>CL</th><th>الموضوع</th>
                                    <th>تاريخ الاستلام</th><th>تاريخ الرد</th><th>الكود</th><th>مهندس ECG</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${groupedData[groupKey].map(row => `
                                    <tr>
                                        <td>${row["رقم الطلب"]}</td>
                                        <td>${(row["REV"] === 0 || row["REV"] === "0" || !row["REV"]) ? '<span class="zero-val">0</span>' : row["REV"]}</td>
                                        <td>${row["CL"] || "-"}</td>
                                        <td style="text-align:right; direction:ltr;">${row["الموضوع"]}</td>
                                        <td>${formatDate(row["تاريخ الاستلام"])}</td>
                                        <td>${formatDate(row["تاريخ الرد"])}</td>
                                        <td class="zero-val">${row["الكود"]}</td>
                                        <td>${row["مهندس ECG"] || "-"}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
                reportContainer.innerHTML += html;
            });
            document.getElementById('printBtn').style.display = "block";
        } else { alert("No Match Data"); }
    }
</script>

</body>
</html>
