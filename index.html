<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… ØªÙ‚Ø§Ø±ÙŠØ± ECG Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Cairo', sans-serif; padding: 20px; background: #f0f4f8; }
        .container { max-width: 1350px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 15px; margin-bottom: 30px; background: #fff; padding: 20px; border: 1px solid #d1d9e6; border-radius: 12px; }
        input[type="file"], input[type="text"] { flex: 1; padding: 12px; border: 2px solid #cbd5e0; border-radius: 8px; font-family: 'Cairo'; }
        button { padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.3s; }
        .btn-search { background: #1a73e8; color: white; }
        .btn-pdf { background: #d93025; color: white; display: none; }
        
        #pdf-area { padding: 10px; background: white; }
        .dynamic-header { 
            text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 25px; color: #004085;
            padding: 15px; border: 3px double #004085; background: #f8f9fa;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background-color: #004085; color: #ffffff; padding: 12px; border: 1px solid #000; font-size: 14px; }
        td { border: 1px solid #000; padding: 10px; text-align: center; font-size: 13px; color: #000; }
        tr:nth-child(even) { background-color: #f2f5f8; }
        .zero-val { font-weight: bold; color: #e67e22; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#1a73e8;">Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© - Ø¥ØµÙ„Ø§Ø­ Ø¹Ù…ÙˆØ¯ REV</h2>
    
    <div class="controls">
        <input type="file" id="fileInput" multiple accept=".xlsx, .xls">
        <input type="text" id="filterInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø­Ø«...">
        <button class="btn-search" onclick="processFiles()">ğŸ” ØªØ´ØºÙŠÙ„</button>
        <button id="pdfBtn" class="btn-pdf" onclick="generatePDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
    </div>
    
    <div id="status" style="text-align:center; margin-bottom:10px; font-weight:bold;"></div>

    <div id="pdf-area">
        <div id="reportTitle" class="dynamic-header" style="display:none;"></div>
        <table id="resultTable" style="display:none;">
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                    <th>REV</th>
                    <th>CL</th>
                    <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯</th>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ù…Ù‡Ù†Ø¯Ø³ ECG</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    function formatDate(d) {
        if (d === 0 || d === "0") return "0";
        if (!d || d === "" || d === undefined) return "-";
        let date = (typeof d === 'number' && d > 30000) ? new Date((d - 25569) * 86400 * 1000) : new Date(d);
        if (isNaN(date.getTime())) return d;
        return `${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`;
    }

    async function processFiles() {
        const fileInput = document.getElementById('fileInput');
        const filterInput = document.getElementById('filterInput').value.trim();
        const tableBody = document.getElementById('tableBody');
        const reportTitle = document.getElementById('reportTitle');
        
        if (!fileInput.files.length || filterInput === "") return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        tableBody.innerHTML = "";
        let count = 0;
        let firstOrder = ""; 

        for (let file of fileInput.files) {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { cellDates: true });
            
            wb.SheetNames.forEach(name => {
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { defval: "" });
                rows.forEach(row => {
                    if (String(row["Ø§Ù„ÙƒÙˆØ¯"]).trim().toUpperCase() === filterInput.toUpperCase()) {
                        count++;
                        if (!firstOrder && row["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]) firstOrder = String(row["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]);

                        let tr = document.createElement('tr');
                        const columns = ["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨", "REV", "CL", "Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯", "Ø§Ù„ÙƒÙˆØ¯", "Ù…Ù‡Ù†Ø¯Ø³ ECG"];

                        columns.forEach(col => {
                            let td = document.createElement('td');
                            let val = row[col];

                            // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© undefined ÙˆØ§Ù„Ù€ 0 ÙÙŠ REV ÙˆØ§Ù„ÙƒÙˆØ¯
                            if (col === "REV" || col === "Ø§Ù„ÙƒÙˆØ¯") {
                                if (val === 0 || val === "0" || val === "" || val === undefined || val === null) {
                                    td.innerHTML = `<span class="zero-val">0</span>`;
                                } else {
                                    td.innerText = val;
                                }
                            } else if (col.includes("ØªØ§Ø±ÙŠØ®")) {
                                td.innerText = formatDate(val);
                            } else {
                                // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                                if (val === undefined || val === null || val === "") {
                                    td.innerText = "-";
                                } else {
                                    td.innerText = val;
                                }
                            }
                            tr.appendChild(td);
                        });
                        tableBody.appendChild(tr);
                    }
                });
            });
        }

        if (count > 0) {
            let comp = "EGC", type = "MAT";
            if (firstOrder.includes("-")) {
                let p = firstOrder.split("-");
                comp = p[0] || "EGC";
                type = p[2] || "MAT";
            }
            const date = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
            reportTitle.innerText = `${comp}-${type}-${filterInput.toUpperCase()} ${date}`;
            reportTitle.style.display = "block";
            document.getElementById('resultTable').style.display = "table";
            document.getElementById('pdfBtn').style.display = "inline-block";
        }
    }

    function generatePDF() {
        const element = document.getElementById('pdf-area');
        const opt = {
            margin: [10, 5, 10, 5],
            filename: `Report.pdf`,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
